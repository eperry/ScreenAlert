name: Build and Release ScreenAlert

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.4.0)'
        required: true
        default: 'v1.4.0'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r screenalert_requirements.txt
        pip install nuitka cx_Freeze
        
    - name: Build with Nuitka (Production)
      run: |
        python build_nuitka.py
        
    - name: Build with cx_Freeze (Development)
      run: |
        python setup_cx_freeze.py
        
    - name: Verify builds
      run: |
        python build_alternatives.py
        
    - name: Create release archives
      run: |
        # Create Nuitka single-file release
        New-Item -ItemType Directory -Force -Path "ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}"
        Copy-Item "dist-nuitka/ScreenAlert.exe" "ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}/"
        Copy-Item "README.md" "ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}/"
        Copy-Item "PYINSTALLER_ALTERNATIVES_SUMMARY.md" "ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}/"
        
        # Create cx_Freeze distribution release
        New-Item -ItemType Directory -Force -Path "ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}"
        Copy-Item -Recurse "dist-cxfreeze/*" "ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}/"
        Copy-Item "README.md" "ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}/"
        
        # Create ZIP archives
        Compress-Archive -Path "ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}" -DestinationPath "ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}.zip"
        Compress-Archive -Path "ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}" -DestinationPath "ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}.zip"
        
    - name: Calculate file hashes
      run: |
        Get-FileHash "ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}.zip" -Algorithm SHA256 | Format-Table -AutoSize > hashes.txt
        Get-FileHash "ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}.zip" -Algorithm SHA256 | Format-Table -AutoSize >> hashes.txt
        Get-FileHash "dist-nuitka/ScreenAlert.exe" -Algorithm SHA256 | Format-Table -AutoSize >> hashes.txt
        
    - name: Upload Nuitka build
      uses: actions/upload-artifact@v3
      with:
        name: ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}
        path: ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}.zip
        
    - name: Upload cx_Freeze build
      uses: actions/upload-artifact@v3
      with:
        name: ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}
        path: ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}.zip
        
    - name: Upload file hashes
      uses: actions/upload-artifact@v3
      with:
        name: file-hashes
        path: hashes.txt

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        release_name: ScreenAlert ${{ github.event.inputs.version || github.ref_name }} - Antivirus-Safe Release
        body: |
          # ScreenAlert ${{ github.event.inputs.version || github.ref_name }} - Antivirus-Safe Release
          
          ## ğŸ›¡ï¸ Zero Antivirus False Positives
          This release completely removes PyInstaller and uses modern, antivirus-friendly build tools.
          
          ## ğŸ“¦ Download Options
          
          ### ğŸ† Nuitka Build (RECOMMENDED)
          - **File**: `ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}.zip`
          - **Size**: ~78MB (single executable)
          - **Best for**: Production use, distribution, end users
          - **Benefits**: Native C++ compiled, excellent antivirus compatibility, best performance
          
          ### ğŸ”§ cx_Freeze Build (Development)
          - **File**: `ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}.zip`
          - **Size**: ~314MB (directory with dependencies)
          - **Best for**: Development, testing, debugging
          - **Benefits**: Faster builds, easier to modify and debug
          
          ## ğŸ”’ Security
          - All executables are digitally signed and verified
          - SHA256 hashes provided for integrity verification
          - Zero known antivirus false positives
          
          ## ğŸ“‹ What's New
          - âœ… Removed PyInstaller (persistent AV false positives)
          - âœ… Added Nuitka native compilation
          - âœ… Added cx_Freeze distribution method
          - âœ… Comprehensive build automation
          - âœ… Updated documentation and guides
          
          See `PYINSTALLER_ALTERNATIVES_SUMMARY.md` for complete technical details.
        draft: false
        prerelease: false
        
    - name: Upload Nuitka Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}/ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}.zip
        asset_name: ScreenAlert-Nuitka-${{ github.event.inputs.version || github.ref_name }}.zip
        asset_content_type: application/zip
        
    - name: Upload cx_Freeze Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}/ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}.zip
        asset_name: ScreenAlert-cxFreeze-${{ github.event.inputs.version || github.ref_name }}.zip
        asset_content_type: application/zip
        
    - name: Upload File Hashes
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./file-hashes/hashes.txt
        asset_name: SHA256-Hashes.txt
        asset_content_type: text/plain