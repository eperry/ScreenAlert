name: Build and Release ScreenAlert

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.4.0)'
        required: true
        default: 'v1.4.0'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'screenalert_requirements.txt'
        
    # Multi-layer caching strategy for maximum speed
    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\pip\Cache
          C:\Users\runneradmin\AppData\Local\pip\Cache
        key: pip-cache-${{ runner.os }}-${{ hashFiles('screenalert_requirements.txt') }}
        restore-keys: |
          pip-cache-${{ runner.os }}-
          
    - name: Cache Nuitka compilation artifacts
      uses: actions/cache@v4
      with:
        path: |
          ~/.nuitka
          ~\AppData\Local\Nuitka
          C:\Users\runneradmin\AppData\Local\Nuitka
          .\screenalert.build
          .\screenalert.dist
          .\screenalert.onefile-build
        key: nuitka-build-${{ runner.os }}-${{ hashFiles('screenalert.py', 'screenalert_requirements.txt') }}-${{ hashFiles('screenalert_config.json') }}
        restore-keys: |
          nuitka-build-${{ runner.os }}-${{ hashFiles('screenalert.py', 'screenalert_requirements.txt') }}-
          nuitka-build-${{ runner.os }}-
          
    - name: Cache compiled Python modules
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\Programs\Python\Python311\Lib\site-packages
          C:\hostedtoolcache\windows\Python\3.11*\x64\Lib\site-packages
        key: python-modules-${{ runner.os }}-${{ hashFiles('screenalert_requirements.txt') }}
        restore-keys: |
          python-modules-${{ runner.os }}-
          
    - name: Cache Nuitka downloaded dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\Nuitka\Nuitka\Cache
          C:\Users\runneradmin\AppData\Local\Nuitka\Nuitka\Cache
        key: nuitka-deps-${{ runner.os }}-${{ hashFiles('screenalert_requirements.txt') }}
        restore-keys: |
          nuitka-deps-${{ runner.os }}-
          
    - name: Cache pre-compiled Nuitka modules
      uses: actions/cache@v4
      with:
        path: |
          .nuitka-precompiled
          ~\AppData\Local\Nuitka\Cache\downloads
          C:\Users\runneradmin\AppData\Local\Nuitka\Cache\downloads
        key: nuitka-precompiled-${{ runner.os }}-${{ hashFiles('screenalert_requirements.txt') }}
        restore-keys: |
          nuitka-precompiled-${{ runner.os }}-
        
    - name: Install dependencies (optimized with caching)
      run: |
        python -m pip install --upgrade pip --no-warn-script-location
        
        # Check if we have cached Nuitka installation
        $nuitkaInstalled = python -c "try: import nuitka; print('installed')" 2>$null
        if ($nuitkaInstalled -ne "installed") {
            Write-Host "Installing Nuitka and core dependencies..."
            pip install --no-deps nuitka ordered-set zstandard
        } else {
            Write-Host "Nuitka found in cache, skipping installation"
        }
        
        # Install project dependencies with caching awareness
        Write-Host "Installing project dependencies..."
        pip install -r screenalert_requirements.txt --no-warn-script-location
        
    - name: Setup Nuitka pre-compilation optimizations
      run: |
        Write-Host "Setting up Nuitka pre-compilation optimizations..."
        python setup_nuitka_precompiled.py
        
    - name: Build with Nuitka (optimized)
      run: |
        python -c "
        import subprocess
        import sys
        import json
        from pathlib import Path
        
        # Create config file if it doesn't exist
        config_file = Path('screenalert_config.json')
        if not config_file.exists():
            print('Creating default config file...')
            default_config = {
                'regions': [],
                'interval': 1500,
                'highlight_time': 5,
                'default_sound': '',
                'default_tts': 'Alert {name}',
                'alert_threshold': 0.98,
                'capture_directory': 'ScreenEvents',
                'alert_only_new_content': True,
                'change_detection_sensitivity': 10,
                'content_analysis_enabled': True
            }
            with open(config_file, 'w') as f:
                json.dump(default_config, f, indent=2)
        
        # Antivirus-safe Nuitka command (reverted problematic flags)
        cmd = [
            sys.executable, '-m', 'nuitka',
            '--onefile',
            '--assume-yes-for-downloads',
            '--enable-plugin=tk-inter',
            '--enable-plugin=numpy', 
            '--windows-console-mode=disable',  # CRITICAL: Keep console disabled for AV safety
            '--product-name=ScreenAlert',
            '--file-description=Screen monitoring and alert system',
            '--product-version=1.4.0',
            '--file-version=1.4.0.0',
            '--copyright=¬© 2025 ScreenAlert',
            '--company-name=ScreenAlert',
            '--output-dir=dist-nuitka',
            '--output-filename=ScreenAlert.exe',
            '--include-data-files=screenalert_config.json=screenalert_config.json',
            '--jobs=4',  # Reduced back to 4 for stability
            '--lto=no',  # Keep LTO disabled for speed
            '--no-prefer-source-code',  # Use bytecode
            '--python-flag=no_docstrings',  # Remove docstrings
            '--python-flag=no_asserts',  # Remove assert statements
            '--show-progress',
            '--show-memory',
            'screenalert.py'
        ]
        
        print('Building with optimized Nuitka settings...')
        result = subprocess.run(cmd, check=True)
        
        # Verify build
        exe_path = Path('dist-nuitka/ScreenAlert.exe')
        if exe_path.exists():
            size_mb = exe_path.stat().st_size / (1024 * 1024)
            print(f'Build successful: {size_mb:.1f} MB')
        else:
            raise Exception('Build failed - executable not found')
        "
        
    - name: Create release archive
      run: |
        # Create release directory
        New-Item -ItemType Directory -Force -Path "ScreenAlert-${{ github.event.inputs.version || github.ref_name }}"
        Copy-Item "dist-nuitka/ScreenAlert.exe" "ScreenAlert-${{ github.event.inputs.version || github.ref_name }}/"
        Copy-Item "README.md" "ScreenAlert-${{ github.event.inputs.version || github.ref_name }}/"
        Copy-Item "screenalert_config.json" "ScreenAlert-${{ github.event.inputs.version || github.ref_name }}/"
        
        # Create ZIP archive
        Compress-Archive -Path "ScreenAlert-${{ github.event.inputs.version || github.ref_name }}" -DestinationPath "ScreenAlert-${{ github.event.inputs.version || github.ref_name }}.zip"
        
    - name: Calculate file hashes
      run: |
        Get-FileHash "ScreenAlert-${{ github.event.inputs.version || github.ref_name }}.zip" -Algorithm SHA256 | Format-Table -AutoSize > hashes.txt
        Get-FileHash "dist-nuitka/ScreenAlert.exe" -Algorithm SHA256 | Format-Table -AutoSize >> hashes.txt
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ScreenAlert-${{ github.event.inputs.version || github.ref_name }}
        path: ScreenAlert-${{ github.event.inputs.version || github.ref_name }}.zip
        
    - name: Upload file hashes
      uses: actions/upload-artifact@v4
      with:
        name: file-hashes
        path: hashes.txt

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release with GitHub CLI
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        
        # Create release notes
        cat << EOF > release_notes.md
        # ScreenAlert $VERSION - Antivirus-Safe Native Executable
        
        ## üõ°Ô∏è Zero Antivirus False Positives
        Built with Nuitka for native C++ compilation - completely eliminates PyInstaller antivirus issues.
        
        ## üì¶ Download
        
        **ScreenAlert-$VERSION.zip** (~78MB)
        - Single native executable (ScreenAlert.exe)
        - Configuration file (screenalert_config.json)
        - Documentation (README.md)
        
        ## üîí Security
        - Native C++ compiled executable
        - SHA256 hashes provided for integrity verification
        - Zero known antivirus false positives
        
        ## üìã What's New in v1.4.0
        - ‚úÖ Replaced PyInstaller with Nuitka (native compilation)
        - ‚úÖ Eliminated all antivirus false positives
        - ‚úÖ Reduced executable size and improved performance
        - ‚úÖ Streamlined build process for reliability
        - ‚úÖ Enhanced security with native code compilation
        
        ## üöÄ Installation
        1. Download ScreenAlert-$VERSION.zip
        2. Extract to desired location
        3. Run ScreenAlert.exe
        4. Configure monitoring regions as needed
        
        Native C++ compilation ensures maximum compatibility and security.
        EOF
        
        # Create the release
        gh release create "$VERSION" \
          --title "ScreenAlert $VERSION - Native Executable" \
          --notes-file release_notes.md \
          --draft=false \
          --prerelease=false \
          "./ScreenAlert-$VERSION/ScreenAlert-$VERSION.zip#ScreenAlert-$VERSION.zip" \
          "./file-hashes/hashes.txt#SHA256-Hashes.txt"